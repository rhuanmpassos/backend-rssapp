// Prisma Schema for RSS Aggregator App
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// USER & AUTH
// =============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // User preferences stored as JSON
  // Example: { "notificationsEnabled": true, "language": "pt-BR" }
  preferences  Json     @default("{}")
  
  // Relations
  subscriptions Subscription[]
  pushTokens    PushToken[]
  folders       Folder[]
  bookmarks     UserBookmark[]
  readItems     UserReadItem[]

  @@map("users")
}

// =============================================
// FOLDERS (Categories/Organização)
// =============================================

model Folder {
  id          String         @id @default(uuid())
  userId      String         @map("user_id")
  name        String         // Nome da pasta (ex: "Esportes", "Culinária")
  color       String?        // Cor opcional para a pasta
  order       Int            @default(0) // Ordem de exibição
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  
  // Relations
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@index([userId])
  @@index([userId, order])
  @@map("folders")
}

// =============================================
// USER BOOKMARKS & READ ITEMS (Sync across devices)
// =============================================

model UserBookmark {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  itemType     String    @map("item_type") // 'feed' | 'video'
  itemId       String    @map("item_id")   // feedItemId or videoId
  title        String
  excerpt      String?
  thumbnailUrl String?   @map("thumbnail_url")
  url          String
  source       String    // Feed title or channel name
  publishedAt  DateTime? @map("published_at")
  savedAt      DateTime  @default(now()) @map("saved_at")
  
  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@index([savedAt])
  @@map("user_bookmarks")
}

model UserReadItem {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  itemType String   @map("item_type") // 'feed' | 'video'
  itemId   String   @map("item_id")
  readAt   DateTime @default(now()) @map("read_at")
  
  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@index([readAt])
  @@map("user_read_items")
}

// =============================================
// SUBSCRIPTIONS
// =============================================

enum SubscriptionType {
  site
  youtube
}

model Subscription {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      SubscriptionType
  target    String           // URL for site, channelId for youtube
  createdAt DateTime         @default(now()) @map("created_at")
  enabled   Boolean          @default(true)
  folderId String?           @map("folder_id") // Pasta opcional
  
  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder    Folder?          @relation(fields: [folderId], references: [id], onDelete: SetNull)
  feed      Feed?            @relation(fields: [feedId], references: [id])
  feedId    String?          @map("feed_id")
  channel   YouTubeChannel?  @relation(fields: [channelId], references: [id])
  channelId String?          @map("channel_id")

  @@index([userId])
  @@index([type])
  @@index([target])
  @@index([folderId])
  @@map("subscriptions")
}

// =============================================
// CUSTOM RSS FEEDS (Admin/Manual)
// =============================================

model Category {
  id        String        @id @default(uuid())
  name      String        @unique
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  
  // Relations
  feeds           CustomFeed[]
  youtubeFeeds    CustomYouTubeFeed[]

  @@map("categories")
}

model CustomFeed {
  id              String           @id @default(uuid())
  title           String           // Título do feed
  description     String?          // Descrição do feed
  slug            String           @unique // URL-friendly identifier
  siteUrl         String?          @map("site_url") // URL do site para extrair notícias
  articleSelector String?          @map("article_selector") // Seletor CSS do container do artigo
  selectors       Json?            // Selectors CSS em JSON: { title, link, subtitle, image, publishedAt }
  categoryId      String?          @map("category_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  
  // Relations
  items           CustomFeedItem[] // Mantido para compatibilidade, mas não será mais usado
  category        Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([categoryId])
  @@map("custom_feeds")
}

model CustomFeedItem {
  id          String      @id @default(uuid())
  feedId      String      @map("feed_id")
  title       String      // Título da notícia
  subtitle    String?     // Subtítulo/parte da notícia
  link        String      // Link da notícia
  imageUrl    String?     @map("image_url") // URL da imagem
  publishedAt DateTime    @default(now()) @map("published_at") // Horário
  content     String?     // Conteúdo completo extraído do link (opcional)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  feed        CustomFeed  @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([feedId])
  @@index([publishedAt])
  @@map("custom_feed_items")
}

// =============================================
// CUSTOM YOUTUBE FEEDS (Admin/Manual)
// =============================================

model CustomYouTubeFeed {
  id              String           @id @default(uuid())
  title           String           // Título do feed
  description     String?          // Descrição do feed
  slug            String           @unique // URL-friendly identifier
  channelId       String?          @map("channel_id") // YouTube Channel ID ou handle
  channelName     String?          @map("channel_name") // Nome do canal do YouTube
  channelUrl      String?          @map("channel_url") // URL completa do canal
  categoryId      String?          @map("category_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  
  // Relations
  category        Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([categoryId])
  @@index([channelId])
  @@map("custom_youtube_feeds")
}

// =============================================
// RSS FEEDS
// =============================================

enum FeedStatus {
  active
  blocked
  error
  pending
}

model Feed {
  id           String     @id @default(uuid())
  url          String     @unique // Original URL provided
  siteDomain   String     @map("site_domain")
  title        String?
  description  String?
  rssUrl       String?    @map("rss_url") // Discovered RSS feed URL
  faviconUrl   String?    @map("favicon_url")
  lastScrapeAt DateTime?  @map("last_scrape_at")
  status       FeedStatus @default(pending)
  errorMessage String?    @map("error_message")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  
  // Relations
  items         FeedItem[]
  subscriptions Subscription[]

  @@index([siteDomain])
  @@index([status])
  @@index([lastScrapeAt])
  @@map("feeds")
}

model FeedItem {
  id           String    @id @default(uuid())
  feedId       String    @map("feed_id")
  url          String
  canonicalUrl String?   @map("canonical_url")
  title        String
  excerpt      String?   // Meta description or first paragraph (NO LLM summary!)
  thumbnailUrl String?   @map("thumbnail_url")
  author       String?
  publishedAt  DateTime? @map("published_at")
  fetchedAt    DateTime  @default(now()) @map("fetched_at")
  contentHash  String    @map("content_hash") // For deduplication
  
  // Relations
  feed         Feed      @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@unique([feedId, contentHash])
  @@unique([feedId, url])
  @@index([feedId])
  @@index([publishedAt])
  @@index([fetchedAt])
  @@map("feed_items")
}

// =============================================
// YOUTUBE
// =============================================

model YouTubeChannel {
  id              String    @id @default(uuid())
  channelId       String    @unique @map("channel_id") // YouTube's channel ID
  title           String
  description     String?
  thumbnailUrl    String?   @map("thumbnail_url")
  customUrl       String?   @map("custom_url") // @username or custom URL
  lastCheckedAt   DateTime? @map("last_checked_at")
  websubTopicUrl  String?   @map("websub_topic_url")
  websubExpiresAt DateTime? @map("websub_expires_at")
  websubSecret    String?   @map("websub_secret") // For HMAC verification
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  videos        YouTubeVideo[]
  subscriptions Subscription[]

  @@index([channelId])
  @@index([lastCheckedAt])
  @@map("youtube_channels")
}

model YouTubeVideo {
  id           String    @id @default(uuid())
  videoId      String    @unique @map("video_id") // YouTube's video ID
  channelDbId  String    @map("channel_db_id") // Our internal channel ID
  title        String
  description  String?   // First 500 chars only (NO LLM summary!)
  thumbnailUrl String?   @map("thumbnail_url")
  duration     String?   // ISO 8601 duration (PT1H2M10S) - legacy field
  publishedAt  DateTime  @map("published_at")
  fetchedAt    DateTime  @default(now()) @map("fetched_at")
  
  // Video classification fields (populated during cron)
  videoType     String?   @map("video_type")     // 'video' | 'short' | 'vod' | 'live'
  isLive        Boolean   @default(false) @map("is_live")
  isLiveContent Boolean   @default(false) @map("is_live_content")
  durationSecs  Int?      @map("duration_secs")  // Duration in seconds
  classifiedAt  DateTime? @map("classified_at")  // When classification was last updated
  
  // Relations
  channel      YouTubeChannel @relation(fields: [channelDbId], references: [id], onDelete: Cascade)

  @@index([channelDbId])
  @@index([publishedAt])
  @@index([fetchedAt])
  @@index([videoType])
  @@index([isLive])
  @@map("youtube_videos")
}

// =============================================
// PUSH NOTIFICATIONS
// =============================================

enum Platform {
  ios
  android
  web
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique // Expo push token
  platform  Platform
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isActive  Boolean  @default(true) @map("is_active")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("push_tokens")
}

// =============================================
// JOB LOGGING
// =============================================

enum JobStatus {
  pending
  running
  completed
  failed
  cancelled
}

enum JobType {
  scrape_feed
  scrape_article
  check_youtube
  send_notification
  websub_subscribe
  websub_renew
}

model JobLog {
  id        String    @id @default(uuid())
  jobType   JobType   @map("job_type")
  target    String    // feedId, channelId, or other identifier
  status    JobStatus @default(pending)
  attempts  Int       @default(0)
  maxRetries Int      @default(3) @map("max_retries")
  lastError String?   @map("last_error")
  result    Json?     // Any result data
  startedAt DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([jobType])
  @@index([status])
  @@index([target])
  @@index([createdAt])
  @@map("job_logs")
}

// =============================================
// RATE LIMIT TRACKING
// =============================================

model RateLimitLog {
  id          String   @id @default(uuid())
  service     String   // 'youtube', 'site:domain.com', etc.
  calls       Int      @default(0)
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  quota       Int?     // Max allowed calls for period
  
  @@unique([service, periodStart])
  @@index([service])
  @@index([periodStart])
  @@map("rate_limit_logs")
}

// =============================================
// WEBSUB SUBSCRIPTIONS (tracking)
// =============================================

model WebSubSubscription {
  id           String    @id @default(uuid())
  topicUrl     String    @map("topic_url")
  hubUrl       String    @map("hub_url")
  callbackUrl  String    @map("callback_url")
  secret       String?
  leaseSeconds Int?      @map("lease_seconds")
  expiresAt    DateTime? @map("expires_at")
  verified     Boolean   @default(false)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([topicUrl, callbackUrl])
  @@index([expiresAt])
  @@map("websub_subscriptions")
}

